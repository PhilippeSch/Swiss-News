name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: macos-15
    
    env:
      DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
      
    - name: Setup WatchOS Simulator
      run: |
        xcrun simctl list
        UDID=$(xcrun simctl create "Apple Watch Ultra 2 (49mm)" com.apple.CoreSimulator.SimDeviceType.Apple-Watch-Ultra-2-49mm)
        xcrun simctl boot $UDID
        echo "UDID=$UDID" >> $GITHUB_ENV
    
    - name: Build and Test
      run: |
        xcodebuild test -scheme "Swiss News Watch App" \
          -destination "id=${{ env.UDID }}" \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults
          
    - name: Convert coverage report
      if: success()
      run: |
        xcrun xccov view --report TestResults.xcresult > coverage.txt
        
    - name: Upload test results
      if: success() || failure()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          TestResults
          coverage.txt
          
    - name: Post Coverage Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const coverage = fs.readFileSync('coverage.txt', 'utf8');
          const comment = `## Test Coverage Report\n\n\`\`\`\n${coverage}\n\`\`\``;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
